name: CI/CD Pipeline for Python API

on:
  push:
    branches:
      - main

env:
  REGISTRY: docker.io/${{ vars.DOCKERHUB_USERNAME }}
  IMAGE_NAME: ${{ vars.DOCKERHUB_IMAGE}}

jobs:
  CI:
    name: Build and Test
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
  
    - name: Build and cache Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true        
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

    - name: Run tests in container
      run: |
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} pytest
    
    - name: Push image if tests pass
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  CD:
    name: Deploy to Cloud VM
    needs: CI
    runs-on: ubuntu-20.04
    if: ${{ success() }}
  
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.CLOUD_VM_PRIV_SSH_KEY }}
        name: id_rsa
        known_hosts: unnecessary
        config: |
          Host jumphost
            HostName shell1.doc.ic.ac.uk
            User et422
            IdentityFile ~/.ssh/id_rsa
            ForwardAgent yes
            StrictHostKeyChecking no
          Host cloud-vm
            HostName cloud-vm-41-85.doc.ic.ac.uk
            User ubuntu
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            ProxyJump jumphost
    
    - name: Deploy to VM
      run: |
        scp ./deploy.sh cloud-vm:~/deploy.sh
        ssh cloud-vm "chmod +x ~/deploy.sh && \
                      DOCKERHUB_USERNAME='${{ vars.DOCKERHUB_USERNAME }}' \
                      DOCKERHUB_ACCESS_TOKEN='${{ secrets.DOCKERHUB_ACCESS_TOKEN }}' \
                      IMAGE_NAME='${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}' \
                      IMAGE_TAG='${{ github.sha }}' \
                      bash ~/deploy.sh"